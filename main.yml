- name: Main
  hosts:
    - 127.0.0.1
  become: true
  vars:
    users_to_configure:
      - root
  pre_tasks:
    - set_fact:
        users_to_configure: "{{ [ { 'user': local_user, 'use_tmux': use_tmux } ] }}"
        powerline_prompt_bg_colors: "{
          '{{ local_user }}': '{{ powerline_prompt_bg_color }}',
          'root': '{{ powerline_prompt_bg_color_root }}'
          }"
        powerline_xonsh_prompt_bg_colors: "{
          '{{ local_user }}': '{{ powerline_xonsh_prompt_bg_color }}',
          'root': '{{ powerline_xonsh_prompt_bg_color_root }}'
          }"
      tags: [ 'user' ]

    - set_fact:
        users_to_configure: "{{ users_to_configure + [ { 'user': 'root', 'use_tmux': false } ] }}"
      when: configure_root|bool
      tags: [ 'user' ]
  roles:
    - { role: linux-common,
        tags: [ 'core' ],
        when: ansible_system == "Linux"
      }

    - { role: helper-scripts,
        helper_x11_copy_script: "{{ x11_copy_script }}",
        helper_x11_enable_forwarding: "{{ x11_enable_forwarding }}",
        helper_host_aliases: "{{ host_aliases }}",
        helper_gpg_local_agent: "{{ gpg_local_agent }}",
        helper_gpg_remote_agent: "{{ gpg_remote_agent }}",
        helper_tmux_copy_script: "{{ use_tmux }}",
        helper_wsl_npiperelay_path: "{{ wsl_npiperelay_path }}",
        helper_windows_gpg_agent_path: "{{ windows_gpg_agent_path }}",
        tags: [ 'core', 'helpers' ] }

    - { role: user-setup,
        user_default_shell: "{{ default_shell }}",
        user_shells: "{{ enabled_shells }}",
        user_secondary_shell: "{{ secondary_shell }}",
        user_users: "{{ users_to_configure }}",
        user_git_email: "{{ git_email }}",
        user_git_name: "{{ git_name }}",
        user_git_signing_key: "{{ git_signing_key }}",
        user_use_tmux: "{{ use_tmux }}",
        user_use_powerline: "{{ use_powerline }}",
        user_powerline_colorscheme: "{{ powerline_colorscheme }}",
        user_powerline_prompt_bg_colors: "{{ powerline_prompt_bg_colors }}",
        user_powerline_xonsh_prompt_bg_colors: "{{ powerline_xonsh_prompt_bg_colors }}",
        user_gpg_public_key_ring: "{{ gpg_public_key_ring }}",
        user_ssh_authorized_keys: "{{ ssh_authorized_keys }}",
        tags: [ 'user' ],
      }

    - { role: cloud-setup,
        cloud_provider: "{{ cloud_provider }}",
        cloud_user: "{{ local_user }}",
        cloud_onedrive_sync_list: "{{ onedrive_sync_list }}",
        tags: [ 'user', 'cloud' ],
      }

    - { role: linux-graphics,
        linux_graphics_install_intel_drivers: "{{ install_intel_drivers }}",
        linux_graphics_install_nvidia_drivers: "{{ install_nvidia_drivers }}",
        tags: [ 'desktop', 'graphics' ],
        when: ansible_system == "Linux"
      }

    - { role: linux-desktop,
        linux_desktop_user: "{{ local_user }}",
        linux_desktop_network: "{{ desktop_network_manager }}",
        linux_desktop_display_manager: "{{ desktop_display_manager }}",
        linux_desktop_environments: "{{ desktop_environments }}",
        tags: [ 'desktop' ],
        when: ansible_system == "Linux"
      }
